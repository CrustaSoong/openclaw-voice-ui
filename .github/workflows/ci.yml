name: ci

on:
  push:
  pull_request:

jobs:
  docker-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t openclaw-voice-ui:ci .

      - name: Verify image runs as non-root (uid != 0)
        run: |
          uid=$(docker run --rm --entrypoint sh openclaw-voice-ui:ci -lc 'id -u')
          echo "container uid=$uid"
          test "$uid" != "0"

      - name: Create docker network
        run: |
          docker network create openclaw-ci

      - name: Start OpenClaw gateway (sidecar)
        run: |
          docker run -d --rm \
            --name openclaw-gateway \
            --network openclaw-ci \
            -e OPENCLAW_GATEWAY_TOKEN=testtoken \
            -p 18789:18789 \
            ghcr.io/openclaw/openclaw:2026.2.6-3

      - name: Wait for OpenClaw gateway to accept connections
        run: |
          # The openclaw image CLI 'health' command has changed across versions;
          # verify readiness by checking the gateway port inside the container.
          for i in $(seq 1 120); do
            if docker exec openclaw-gateway node -e "const net=require('net');const s=net.connect(18789,'127.0.0.1');s.on('connect',()=>process.exit(0));s.on('error',()=>process.exit(1));" >/dev/null 2>&1; then
              echo "gateway ready"; exit 0
            fi
            sleep 1
          done
          echo "gateway did not become ready" >&2
          docker logs openclaw-gateway || true
          exit 1

      - name: Start WSS reverse proxy (TLS termination)
        run: |
          cat > /tmp/Caddyfile <<'EOF'
          :443 {
            tls internal
            reverse_proxy openclaw-gateway:18789
          }
          EOF

          docker run -d --rm \
            --name openclaw-wss \
            --network openclaw-ci \
            -p 8443:443 \
            -v /tmp/Caddyfile:/etc/caddy/Caddyfile:ro \
            caddy:2-alpine

      - name: Wait for WSS handshake (repeat)
        env:
          NODE_TLS_REJECT_UNAUTHORIZED: "0"
        run: |
          # Use a self-signed cert (caddy tls internal). For CI smoke, disable TLS verification.
          # Repeat connects to catch flaky proxy startup / intermittent handshake failures.
          node - <<'NODE'
          const { WebSocket } = require('undici');

          const url = 'wss://127.0.0.1:8443';
          const attempts = 10;
          const delayMs = 500;
          const perAttemptTimeoutMs = 5000;

          const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

          async function tryOnce(i) {
            return await new Promise((resolve, reject) => {
              const ws = new WebSocket(url);
              const t = setTimeout(() => {
                try { ws.close(); } catch {}
                reject(new Error(`attempt ${i}: timeout after ${perAttemptTimeoutMs}ms`));
              }, perAttemptTimeoutMs);

              ws.onopen = () => {
                clearTimeout(t);
                ws.close();
                resolve();
              };
              ws.onerror = (e) => {
                clearTimeout(t);
                reject(new Error(`attempt ${i}: error ${e && e.message ? e.message : String(e)}`));
              };
            });
          }

          (async () => {
            for (let i = 1; i <= attempts; i++) {
              try {
                await tryOnce(i);
                console.log(`wss ok (attempt ${i}/${attempts})`);
              } catch (err) {
                console.error(`wss failed (attempt ${i}/${attempts}):`, err.message || err);
                process.exit(1);
              }
              await sleep(delayMs);
            }
          })();
          NODE

      - name: Start voice-ui container
        run: |
          docker run -d --rm \
            -p 8080:8080 \
            --network openclaw-ci \
            -e OPENCLAW_GATEWAY_URL=wss://openclaw-wss \
            -e OPENCLAW_GATEWAY_TOKEN=testtoken \
            --name voice-ui \
            openclaw-voice-ui:ci

      - name: Wait for HTTP
        run: |
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8080/ >/dev/null; then
              echo "ready"; exit 0
            fi
            sleep 0.5
          done
          echo "server did not become ready" >&2
          docker logs voice-ui || true
          exit 1

      - name: Smoke check content + runtime config
        run: |
          curl -fsS http://127.0.0.1:8080/ | head -n 20
          curl -fsS http://127.0.0.1:8080/config.js | tee /tmp/config.js
          grep -q 'gatewayUrl: "wss://openclaw-wss"' /tmp/config.js
          grep -q 'gatewayToken: "testtoken"' /tmp/config.js

      - name: Nginx config test (inside container)
        run: |
          docker exec voice-ui nginx -t

      - name: Dump logs on failure
        if: failure()
        run: |
          docker logs openclaw-gateway || true
          docker logs voice-ui || true

      - name: Stop containers
        if: always()
        run: |
          docker stop voice-ui || true
          docker stop openclaw-wss || true
          docker stop openclaw-gateway || true
          docker network rm openclaw-ci || true
