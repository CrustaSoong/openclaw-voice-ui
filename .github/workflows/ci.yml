name: ci

on:
  push:
  pull_request:

jobs:
  docker-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t openclaw-voice-ui:ci .

      - name: Verify image runs as non-root (uid != 0)
        run: |
          uid=$(docker run --rm --entrypoint sh openclaw-voice-ui:ci -lc 'id -u')
          echo "container uid=$uid"
          test "$uid" != "0"

      - name: Create docker network
        run: |
          docker network create openclaw-ci

      - name: Start OpenClaw gateway (sidecar)
        run: |
          docker run -d --rm \
            --name openclaw-gateway \
            --network openclaw-ci \
            -e OPENCLAW_GATEWAY_TOKEN=testtoken \
            -p 18789:18789 \
            ghcr.io/openclaw/openclaw:2026.2.6-3

      - name: Wait for OpenClaw gateway health
        run: |
          for i in $(seq 1 60); do
            if docker exec openclaw-gateway node /app/dist/index.js health --token testtoken >/dev/null 2>&1; then
              echo "gateway ready"; exit 0
            fi
            sleep 1
          done
          echo "gateway did not become healthy" >&2
          docker logs openclaw-gateway || true
          exit 1

      - name: Start voice-ui container
        run: |
          docker run -d --rm \
            -p 8080:8080 \
            --network openclaw-ci \
            -e OPENCLAW_GATEWAY_URL=ws://openclaw-gateway:18789 \
            -e OPENCLAW_GATEWAY_TOKEN=testtoken \
            --name voice-ui \
            openclaw-voice-ui:ci

      - name: Wait for HTTP
        run: |
          for i in $(seq 1 30); do
            if curl -fsS http://127.0.0.1:8080/ >/dev/null; then
              echo "ready"; exit 0
            fi
            sleep 0.5
          done
          echo "server did not become ready" >&2
          docker logs voice-ui || true
          exit 1

      - name: Smoke check content + runtime config
        run: |
          curl -fsS http://127.0.0.1:8080/ | head -n 20
          curl -fsS http://127.0.0.1:8080/config.js | tee /tmp/config.js
          grep -q 'gatewayUrl: "ws://openclaw-gateway:18789"' /tmp/config.js
          grep -q 'gatewayToken: "testtoken"' /tmp/config.js

      - name: Nginx config test (inside container)
        run: |
          docker exec voice-ui nginx -t

      - name: Dump logs on failure
        if: failure()
        run: |
          docker logs openclaw-gateway || true
          docker logs voice-ui || true

      - name: Stop containers
        if: always()
        run: |
          docker stop voice-ui || true
          docker stop openclaw-gateway || true
          docker network rm openclaw-ci || true
